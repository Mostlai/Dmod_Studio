<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dominions Mod Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-sidebar: #252526; --bg-activity: #333333;
            --bg-input: #3c3c3c; --bg-hover: #2a2d2e; --bg-selection: #37373d;
            --border-color: #454545; --accent-color: #007acc;
            --text-main: #cccccc; --text-muted: #858585; --text-header: #e7e7e7;
            --sh-cmd: #569cd6; --sh-val: #ce9178; --sh-comment: #6a9955; --sh-key: #9cdcfe;
            --font-code: "JetBrains Mono", "Consolas", monospace;
            --font-ui: "Segoe UI", "Microsoft YaHei", sans-serif;
            --radius: 2px;
            --kofi-color: #FF5E5B;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-main); color: var(--text-main); font-family: var(--font-ui); font-size: 13px; display: flex; height: 100vh; overflow: hidden; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 3px; }

        /* Activity Bar */
        .activity-bar { width: 48px; background: var(--bg-activity); display: flex; flex-direction: column; justify-content: space-between; flex-shrink: 0; z-index: 200; }
        .activity-icon { width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.6; color: #fff; font-size: 20px; transition: 0.2s; border-left: 2px solid transparent; }
        .activity-icon:hover, .activity-icon:active { opacity: 1; }
        /* Active state for desktop toggles */
        .activity-icon.active { opacity: 1; border-left-color: #fff; background: var(--bg-sidebar); }
        .lang-btn { font-size: 12px; font-weight: bold; }

        /* Panels */
        .sidebar { width: 260px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; flex-shrink: 0; transition: width 0.1s ease, transform 0.1s ease; }
        .sidebar-header { padding: 0 12px; height: 35px; display: flex; align-items: center; font-size: 11px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid #111; }
        
        .tree-view { overflow-y: auto; flex: 1; }
        .tree-row { display: flex; align-items: center; padding: 10px 12px; white-space: nowrap; cursor: pointer; border-left: 2px solid transparent; transition: 0.1s; }
        .tree-row:hover { background: var(--bg-hover); }
        .tree-row.selected { background: var(--bg-selection); border-left-color: var(--accent-color); color: #fff; }
        .tree-icon { width: 22px; text-align: center; margin-right: 8px; font-size: 14px; }
        
        .list-panel { width: 300px; background: var(--bg-sidebar); border-right: 1px solid #111; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.1s ease; }
        .list-header { padding: 10px; background: #2d2d2d; border-bottom: 1px solid #111; display: flex; flex-direction: column; gap: 8px; }
        .search-input { width: 100%; background: var(--bg-input); border: 1px solid transparent; color: #fff; padding: 8px; font-size: 13px; border-radius: 4px; }
        .search-input:focus { border-color: var(--accent-color); }
        
        .btn-new-item { width: 100%; padding: 8px; background: var(--accent-color); color: white; border: none; cursor: pointer; font-size: 13px; font-weight: bold; border-radius: 4px; }
        
        .btn-kofi {
            width: 100%; padding: 8px; background: var(--kofi-color); color: white; 
            border: none; cursor: pointer; font-size: 13px; font-weight: bold; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            text-decoration: none; transition: 0.2s;
        }
        .btn-kofi:hover { background: #ff4642; box-shadow: 0 2px 8px rgba(255, 94, 91, 0.4); }

        .entry-list { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        .entry-item { padding: 12px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #2a2a2a; }
        .entry-item:hover { background: var(--bg-hover); }
        .entry-item.active { background: #094771; }
        .entry-id { color: var(--sh-val); width: 45px; font-family: var(--font-code); font-size: 11px; flex-shrink: 0; }
        .entry-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 5px; }
        .entry-actions { display: flex; gap: 12px; opacity: 0; transition: 0.2s; }
        .entry-item:hover .entry-actions { opacity: 1; }
        .btn-icon { color: #888; cursor: pointer; padding: 4px; font-size: 14px; }
        .btn-icon:hover { color: #fff; }
        .btn-icon.del:hover { color: #f44336; }

        /* Editor */
        /* Key Fix: min-width: 0 prevents flex child from overflowing */
        .editor-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); overflow: hidden; position: relative; min-width: 0; }
        .editor-split { flex: 1; display: flex; overflow: hidden; position: relative; }
        .form-view { flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 100px; min-width: 0; }
        
        /* Layout Fix: optimized grid columns for tighter spaces */
        .form-row { display: grid; grid-template-columns: 140px 1fr 60px; gap: 10px; margin-bottom: 8px; padding: 4px; border-radius: var(--radius); align-items: start; }
        .form-row:hover { background: #2a2d2e; }
        .lbl { text-align: right; color: var(--sh-key); font-family: var(--font-code); padding-top: 6px; font-weight: 500; font-size: 12px; background: none; border: none; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .auto-textarea { 
            background: var(--bg-input); border: 1px solid transparent; color: var(--text-main); 
            font-family: var(--font-code); padding: 8px 10px; width: 100%; resize: none; overflow: hidden;
            line-height: 1.5; font-size: 13px; border-radius: 2px;
            min-width: 0; /* Important for grid responsiveness */
        }
        .auto-textarea:focus { border-color: var(--accent-color); outline: none; }
        .inp-comment { background: transparent; border: none; color: var(--sh-comment); font-size: 11px; font-style: italic; width: 100%; font-family: var(--font-code); margin-top: 4px; }
        .cmd-info { font-size: 11px; color: #aaa; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 2px; margin-top: 4px; border-left: 2px solid var(--accent-color); display: none; }

        .row-actions { display: flex; gap: 8px; padding-top: 6px; justify-content: flex-end; opacity: 0; transition: 0.2s; }
        .form-row:hover .row-actions { opacity: 1; }
        .btn-action { cursor: pointer; font-size: 14px; color: #858585; padding: 2px 6px; }
        .btn-action:hover { color: #fff; background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* Preview Panel - Fixed for medium screens */
        .preview-view { width: 400px; background: #1e1e1e; border-left: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .code-content { flex: 1; padding: 15px; overflow: auto; font-family: var(--font-code); font-size: 12px; white-space: pre-wrap; color: #d4d4d4; line-height: 1.6; }
        
        .tok-cmd { color: var(--sh-cmd); font-weight: bold; }
        .tok-val { color: var(--sh-val); }
        .tok-com { color: var(--sh-comment); }
        .tok-kw { color: #c586c0; font-weight: bold; }

        #bottomPanel { height: 0; overflow: hidden; background: #252526; border-top: 1px solid #333; transition: 0.2s; }
        .stats-grid { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; }
        .stat-box { background: #333; padding: 10px; min-width: 140px; border-radius: 4px; }
        .stat-bar-outer { height: 4px; background: #444; margin-top: 8px; width: 100%; border-radius: 2px; overflow: hidden; }
        .stat-bar-inner { height: 100%; background: var(--accent-color); width: 0%; transition: 0.4s ease-out; }

        .status-bar { height: 22px; background: var(--accent-color); color: #fff; display: flex; align-items: center; padding: 0 10px; font-size: 11px; justify-content: space-between; flex-shrink: 0; }
        
        /* Modals & Suggestions */
        .vsc-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; display: none; justify-content: center; align-items: flex-start; padding-top: 50px; }
        .vsc-modal { background: #252526; border: 1px solid #454545; width: 450px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; border-radius: 4px; }
        .vsc-modal-header { padding: 10px 15px; font-weight: bold; font-size: 12px; color: #969696; background: #2d2d2d; border-radius: 4px 4px 0 0; }
        .vsc-modal-body { padding: 20px; font-size: 13px; color: #cccccc; max-height: 60vh; overflow-y: auto; }
        .vsc-modal-footer { padding: 10px 15px; display: flex; justify-content: flex-end; gap: 10px; background: #2d2d2d; border-radius: 0 0 4px 4px; }
        .btn-secondary { background: #3e3e42; color: #fff; border: none; padding: 6px 14px; cursor: pointer; font-size: 12px; border-radius: 2px; }
        
        .vsc-list { display: flex; flex-direction: column; max-height: 300px; overflow-y: auto; }
        .vsc-list-item { padding: 10px; cursor: pointer; font-size: 13px; border-radius: 2px; border-bottom: 1px solid #333; }
        .vsc-list-item:hover { background: #094771; color: #fff; }

        .vsc-suggest-widget { position: fixed; background: #252526; border: 1px solid #454545; z-index: 30000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: none; max-height: 250px; overflow-y: auto; width: 320px; border-radius: 4px; }
        .vsc-suggest-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 2px; }
        .vsc-suggest-item:hover { background: #094771; }
        .vsc-suggest-label { font-family: var(--font-code); font-weight: bold; color: var(--sh-cmd); font-size: 13px; }
        .vsc-suggest-desc { font-size: 12px; color: #999; }

        /* Defaults for mobile hidden */
        .mobile-toolbar { display: none; }
        .mobile-list-header { display: none; }

        /* Utility for desktop toggling */
        .desktop-hidden { display: none !important; }

        /* --- Mobile Adaptations --- */
        @media (max-width: 768px) {
            body { flex-direction: column; position: relative; }
            .activity-bar { width: 100%; height: 50px; flex-direction: row; border-right: none; border-top: 1px solid #333; position: absolute; bottom: 0; left: 0; }
            .activity-bar > div { display: flex; flex: 1; justify-content: space-around; }
            .activity-bottom { display: flex; flex-direction: row; width: 100%; justify-content: space-around; padding: 0 10px; }
            .activity-top { display: none; }
            .sidebar, .list-panel, .editor-container { width: 100%; height: calc(100% - 50px); position: absolute; top: 0; left: 0; background: var(--bg-main); z-index: 10; display: none; border-right: none; }
            .sidebar { z-index: 30; } .list-panel { z-index: 20; } .editor-container { z-index: 15; }
            /* Mobile View Switching Logic */
            .view-active { display: flex !important; }
            
            .entry-item { padding: 15px; } .entry-actions { opacity: 1; } .btn-icon { padding: 8px; font-size: 16px; }
            .mobile-list-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
            .form-view { padding: 10px; padding-bottom: 80px; }
            .preview-view { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
            .preview-view.active { display: flex; }
            .form-row { display: flex; flex-wrap: wrap; position: relative; padding: 10px; background: #252526; margin-bottom: 12px; border: 1px solid #333; }
            .lbl { width: auto; text-align: left; font-size: 13px; color: var(--sh-cmd); margin-bottom: 4px; padding-top: 0; flex-basis: 70%; }
            .row-actions { position: absolute; top: 8px; right: 8px; opacity: 1 !important; padding: 0; }
            .btn-action { font-size: 16px; padding: 8px; color: #aaa; } .btn-action.add { color: #4ade80; } .btn-action.del { color: #ef4444; }
            .form-row > div:nth-child(2) { width: 100%; margin-top: 5px; }
            .auto-textarea { font-size: 14px; padding: 12px; background: #111; }
            .mobile-toolbar { height: 45px; background: #2d2d2d; border-bottom: 1px solid #444; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
            .mobile-back-btn { color: #fff; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
            .status-bar { display: none; }
            
            /* Reset utility styles for mobile */
            .desktop-hidden { display: flex !important; }
        }

        /* Tour Guide */
        #tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 40000; display: none; }
        #tour-tooltip { position: fixed; z-index: 40002; background: #252526; color: #fff; padding: 15px; border-radius: 4px; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #454545; display: none; }
        .tour-highlight { position: relative; z-index: 40001 !important; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); pointer-events: none; }
        #tour-title { margin-top:0; color:var(--accent-color); font-size:14px; font-weight:bold; }
        #tour-desc { color:#cccccc; font-size:13px; line-height:1.5; margin:10px 0; }

        /* Media Queries for Desktop Space Saving */
        @media (min-width: 769px) and (max-width: 1366px) {
             /* Compact sidebar for laptops */
             .sidebar { width: 220px; }
             .list-panel { width: 250px; }
             .preview-view { width: 350px; }
             /* Allow preview to be hidden if user wants, though we use the toggle button now */
        }
    </style>
</head>
<body onclick="hideSuggestions()">

    <div id="vscModalOverlay" class="vsc-modal-overlay">
        <div class="vsc-modal">
            <div id="modalHeader" class="vsc-modal-header">MODAL</div>
            <div id="modalBody" class="vsc-modal-body"></div>
            <div id="modalFooter" class="vsc-modal-footer"></div>
        </div>
    </div>

    <!-- Tour Elements -->
    <div id="tour-overlay"></div>
    <div id="tour-tooltip">
        <div id="tour-title"></div>
        <div id="tour-desc"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-secondary" onclick="tour.end()" data-i18n="BTN_SKIP">跳过</button>
            <div style="display:flex; gap:10px; align-items:center">
                <span id="tour-count" style="font-size:11px; color:#888"></span>
                <button class="btn-new-item" style="width:auto; padding:4px 12px;" onclick="tour.next()" id="tour-btn-next" data-i18n="BTN_NEXT">下一步</button>
            </div>
        </div>
    </div>

    <!-- Suggestion Widget -->
    <div id="suggestWidget" class="vsc-suggest-widget"></div>

    <div class="activity-bar">
        <div class="activity-top" style="display:none"></div>
        <div class="activity-bottom">
            <!-- Modified OnClick to handle Desktop Toggling -->
            <div class="activity-icon active" id="act-icon-sidebar" onclick="handleNavClick('sidebar')" title="分类"><i class="fa-solid fa-list-ul"></i></div>
            <div class="activity-icon active" id="act-icon-list" onclick="handleNavClick('list')" title="列表"><i class="fa-solid fa-file-lines"></i></div>
            <!-- The Editor icon is mostly for mobile switching or desktop 'focus' -->
            <div class="activity-icon" id="act-icon-editor" onclick="handleNavClick('editor')" title="编辑/预览"><i class="fa-solid fa-pen-to-square"></i></div>
            
            <!-- Tools -->
            <div class="activity-icon lang-btn" onclick="toggleLanguage()">中/En</div>
            <div class="activity-icon" onclick="showDonate()" title="捐赠"><i class="fa-solid fa-heart"></i></div>
            <div class="activity-icon" onclick="showAbout()" title="关于"><i class="fa-solid fa-circle-info"></i></div>
            <div class="activity-icon" onclick="showSettings()" title="设置"><i class="fa-solid fa-gear"></i></div>
        </div>
    </div>

    <div class="sidebar view-active" id="view-sidebar">
        <div class="sidebar-header" data-i18n="HDR_EXPLORER">资源分类</div>
        <div class="tree-view" id="mainTree"></div>
        
        <div style="padding: 10px; border-top: 1px solid #333; display:flex; flex-direction: column; gap: 8px;">
            <a href="https://ko-fi.com/pldada" target="_blank" class="btn-kofi">
                <i class="fa-solid fa-mug-hot"></i> <span data-i18n="BTN_KOFI">Ko-fi 赞助</span>
            </a>
            <div style="display:flex; gap:5px;">
                <button class="auto-textarea" style="cursor:pointer; text-align:center; font-size:11px; flex:1;" onclick="document.getElementById('fileInput').click()" data-i18n="BTN_IMPORT">导入</button>
                <button class="auto-textarea" style="background:var(--accent-color); cursor:pointer; text-align:center; font-size:11px; flex:1;" onclick="exportFile()" data-i18n="BTN_EXPORT">导出</button>
            </div>
            <input type="file" id="fileInput" accept=".txt,.dm" style="display:none" onchange="loadFile(this)">
        </div>
    </div>

    <div class="list-panel" id="view-list">
        <div class="list-header">
            <div class="mobile-list-header">
                <span style="font-weight:bold; color:#fff" id="listTitle">列表</span>
                <i class="fa-solid fa-arrow-left" style="padding:5px; cursor:pointer" onclick="handleNavClick('sidebar')"><span data-i18n="BTN_BACK_CAT"> 返回分类</span></i>
            </div>
            <button class="btn-new-item" onclick="createNewItem()"><i class="fa-solid fa-plus"></i> <span data-i18n="BTN_NEW_ITEM">新增项目</span></button>
            <input type="text" class="search-input" id="searchInput" placeholder="Search..." onkeyup="filterItems()">
        </div>
        <div class="entry-list" id="entryList"></div>
    </div>

    <div class="editor-container view-active" id="view-editor">
        <div class="mobile-toolbar" id="mobileToolbar">
            <div class="mobile-back-btn" onclick="handleNavClick('list')"><i class="fa-solid fa-chevron-left"></i> <span data-i18n="BTN_BACK_LIST">列表</span></div>
            <div style="    padding: 10px;display: flex; gap: 15px;align-items: center;;">
                <i class="fa-solid fa-eye" onclick="togglePreview()" style="color:#ccc; cursor:pointer"></i>
            </div>
        </div>

        <div class="editor-split">
            <div class="form-view" id="formView">
                <div style="height:100%; display:flex; align-items:center; justify-content:center; color:#555; flex-direction:column;">
                    <i class="fa-solid fa-code" style="font-size:60px; margin-bottom:20px;"></i>
                    <p data-i18n="MSG_SELECT_CAT">选择一个分类开始构建</p>
                </div>
            </div>
            <div class="preview-view" id="previewPanel">
                <div style="padding:12px; font-size:12px; color:var(--text-muted); background:#252526; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <span><span data-i18n="HDR_PREVIEW">代码预览</span></span>
                    <div style="display:flex; gap:10px">
                        <i class="fa-regular fa-copy" style="cursor:pointer; padding:5px;" onclick="copyPreview()" title="复制"></i>
                        <i class="fa-solid fa-xmark" style="cursor:pointer; padding:5px;" onclick="togglePreviewPanel()" title="Hide"></i>
                    </div>
                </div>
                <div class="code-content" id="codePreview"></div>
            </div>
        </div>
        
        <div id="bottomPanel">
            <div class="stats-grid" id="statsContent"></div>
        </div>

        <div class="status-bar">
            <div id="statusMsg" data-i18n="MSG_READY">就绪</div>
            <div style="display:flex; gap:15px;">
                <span id="objCount">Total: 0</span>
                <span>Dominions Mod Studio v1.6.3</span>
            </div>
        </div>
    </div>

<script>
// --- I18N SYSTEM ---
let currentLang = localStorage.getItem('dms-lang') || 'cn';

const I18N = {
    // Categories
    "CAT_META": { cn: "Mod 元信息", en: "Mod Info" },
    "CAT_MONSTER": { cn: "单位 (Monsters)", en: "Monsters" },
    "CAT_NATION": { cn: "国家 (Nations)", en: "Nations" },
    "CAT_GOD": { cn: "准神 (Gods)", en: "Gods" },
    "CAT_SPELL": { cn: "法术 (Spells)", en: "Spells" },
    "CAT_ARMOR": { cn: "防具 (Armor)", en: "Armor" },
    "CAT_WEAPON": { cn: "武器 (Weapons)", en: "Weapons" },
    "CAT_SITE": { cn: "遗迹 (Sites)", en: "Sites" },
    "CAT_ITEM": { cn: "物品 (Items)", en: "Items" },
    "CAT_NAME": { cn: "命名 (Names)", en: "Names" },
    "CAT_EVENT": { cn: "事件 (Events)", en: "Events" },
    "CAT_BLESS": { cn: "祝福 (Bless)", en: "Bless Effects" },

    // Static UI
    "HDR_EXPLORER": { cn: "资源分类", en: "Explorer" },
    "BTN_IMPORT": { cn: "导入", en: "Import" },
    "BTN_EXPORT": { cn: "导出", en: "Export" },
    "BTN_BACK_CAT": { cn: "返回分类", en: "Categories" },
    "BTN_NEW_ITEM": { cn: "新增项目", en: "New Item" },
    "BTN_BACK_LIST": { cn: "列表", en: "List" },
    "MSG_SELECT_CAT": { cn: "选择一个分类开始构建", en: "Select a category to start" },
    "HDR_PREVIEW": { cn: "代码预览", en: "Preview" },
    "MSG_READY": { cn: "就绪", en: "Ready" },
    "BTN_SKIP": { cn: "跳过", en: "Skip" },
    "BTN_NEXT": { cn: "下一步", en: "Next" },
    "BTN_FINISH": { cn: "完成", en: "Finish" },
    "BTN_START": { cn: "开始使用", en: "Start" },
    "BTN_CLOSE": { cn: "关闭", en: "Close" },
    "BTN_CANCEL": { cn: "取消", en: "Cancel" },
    "BTN_CONFIRM": { cn: "确认", en: "Confirm" },
    "BTN_KOFI": { cn: "Ko-fi 赞助", en: "Support on Ko-fi" },

    // Dynamic
    "TXT_UNTITLED": { cn: "(未命名)", en: "(Untitled)" },
    "TXT_TOTAL": { cn: "总计", en: "Total" },
    "MSG_DEL_CONFIRM": { cn: "确定要删除这个条目", en: "Delete this item" },
    "MSG_DEL_ROW": { cn: "删除此行？", en: "Delete this row?" },
    "BTN_ADD_TAG": { cn: "添加标签", en: "Add Tag" },
    "BTN_ADD_PROP": { cn: "添加属性", en: "Add Property" },
    "PH_COMMENT": { cn: "-- 注释", en: "-- Comment" },
    "PH_SEARCH": { cn: "搜索条目...", en: "Search items..." },
    
    // Dialogs
    "DLG_ABOUT": { cn: "关于", en: "About" },
    "DLG_DONATE": { cn: "捐赠", en: "Donate" },
    "DLG_SETTINGS": { cn: "设置", en: "Settings" },
    "TXT_SUPPORT": { cn: "支持开发者", en: "Support Developer" },
    "TXT_DONATE_MSG": { cn: "感谢您的支持！您的支持是我更新的动力", en: "Thanks for your support!" },
    "TXT_EXPORT_DICT": { cn: "导出当前 Mod 所有命令为字典 (JSON)", en: "Export Command Dictionary (JSON)" },
    
    // Tour
    "TOUR_1_T": { cn: "多功能侧边栏", en: "Sidebar / Nav" },
    "TOUR_1_D": { cn: "点击左侧图标可切换或折叠侧边栏，获取更多编辑空间。", en: "Click icons to toggle sidebar panels." },
    "TOUR_2_T": { cn: "对象分类", en: "Categories" },
    "TOUR_2_D": { cn: "选择 Mod 的不同类别。", en: "Select mod object types." },
    "TOUR_3_T": { cn: "条目列表", en: "Item List" },
    "TOUR_3_D": { cn: "管理你的修改项。支持新增、删除以及复制。", en: "Manage, copy, delete items." },
    "TOUR_4_T": { cn: "代码预览", en: "Code Preview" },
    "TOUR_4_D": { cn: "实时查看生成的 .dm 代码。", en: "Real-time DM code generation." },
    "TOUR_5_T": { cn: "导入与导出", en: "I/O" },
    "TOUR_5_D": { cn: "支持导入现有的 Mod 文件。", en: "Import existing mods or export." },
    "TOUR_END_T": { cn: "欢迎使用", en: "Welcome" },
    "TOUR_END_D": { cn: "祝您 Mod 制作愉快！", en: "Happy Modding!" }
};

function t(key) {
    if (!I18N[key]) return key;
    return I18N[key][currentLang] || I18N[key]['cn'];
}

function toggleLanguage() {
    currentLang = currentLang === 'cn' ? 'en' : 'cn';
    localStorage.setItem('dms-lang', currentLang);
    updateInterfaceText();
}

function updateInterfaceText() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        el.innerText = t(el.getAttribute('data-i18n'));
    });
    
    document.getElementById('searchInput').placeholder = t('PH_SEARCH');
    document.querySelectorAll('.inp-comment').forEach(el => el.placeholder = t('PH_COMMENT'));

    renderTree();
    renderList();
    if(currentSelection.item) {
        currentSelection.item.isMeta ? loadMetadata() : loadItem(currentSelection.item);
    }
    updateStats();
}

// --- Navigation Logic (Mobile vs Desktop) ---

function handleNavClick(viewName) {
    // 手机端：切换视图
    if (window.innerWidth <= 768) {
        switchViewMobile(viewName);
    } 
    // 桌面端：折叠/展开面板
    else {
        toggleDesktopPanel(viewName);
    }
}

function switchViewMobile(viewName) {
    document.getElementById('view-sidebar').classList.remove('view-active');
    document.getElementById('view-list').classList.remove('view-active');
    document.getElementById('view-editor').classList.remove('view-active');
    document.getElementById('view-' + viewName).classList.add('view-active');
    
    // Update Icons
    document.querySelectorAll('.activity-bottom .activity-icon').forEach(el => el.classList.remove('active'));
    if(viewName==='sidebar') document.getElementById('act-icon-sidebar').classList.add('active');
    if(viewName==='list') document.getElementById('act-icon-list').classList.add('active');
    if(viewName==='editor') document.getElementById('act-icon-editor').classList.add('active');
}

function toggleDesktopPanel(panel) {
    if (panel === 'sidebar') {
        const el = document.getElementById('view-sidebar');
        const icon = document.getElementById('act-icon-sidebar');
        if (el.classList.contains('desktop-hidden')) {
            el.classList.remove('desktop-hidden');
            icon.classList.add('active');
        } else {
            el.classList.add('desktop-hidden');
            icon.classList.remove('active');
        }
    } else if (panel === 'list') {
        const el = document.getElementById('view-list');
        const icon = document.getElementById('act-icon-list');
        if (el.classList.contains('desktop-hidden')) {
            el.classList.remove('desktop-hidden');
            icon.classList.add('active');
        } else {
            el.classList.add('desktop-hidden');
            icon.classList.remove('active');
        }
    } else if (panel === 'editor') {
        // Desktop click on editor icon basically toggles preview panel for more space
        togglePreviewPanel();
    }
}

function togglePreviewPanel() {
    const p = document.getElementById('previewPanel');
    const icon = document.getElementById('act-icon-editor');
    if (p.style.display === 'none') {
        p.style.display = 'flex';
        // icon.classList.add('active');
    } else {
        p.style.display = 'none';
        // icon.classList.remove('active');
    }
}

// Mobile specific preview toggle
function togglePreview() {
    const p = document.getElementById('previewPanel');
    p.classList.toggle('active');
}

// Initialize Logic
if (window.innerWidth <= 768) {
    switchViewMobile('sidebar'); 
} else {
    // Desktop Defaults: Sidebar and List are active
}

// --- State & Config ---
const CATEGORIES = [
    { id: 'metadata', i18n: 'CAT_META', icon: 'fa-gears', prefix: '#modname' },
    { id: 'monster', i18n: 'CAT_MONSTER', icon: 'fa-dragon', prefix: '#newmonster' },
    { id: 'nation', i18n: 'CAT_NATION', icon: 'fa-flag', prefix: '#newnation' },
    { id: 'god', i18n: 'CAT_GOD', icon: 'fa-hand-fist' },
    { id: 'spell', i18n: 'CAT_SPELL', icon: 'fa-wand-sparkles', prefix: '#newspell' },
    { id: 'armor', i18n: 'CAT_ARMOR', icon: 'fa-shield-halved', prefix: '#newarmor' },
    { id: 'weapon', i18n: 'CAT_WEAPON', icon: 'fa-hammer', prefix: '#newweapon' },
    { id: 'site', i18n: 'CAT_SITE', icon: 'fa-dungeon', prefix: '#newsite' },
    { id: 'item', i18n: 'CAT_ITEM', icon: 'fa-gem', prefix: '#newitem' },
    { id: 'nametype', i18n: 'CAT_NAME', icon: 'fa-signature', prefix: '#selectnametype' },
    { id: 'event', i18n: 'CAT_EVENT', icon: 'fa-bolt', prefix: '#newevent' },
    { id: 'bless', i18n: 'CAT_BLESS', icon: 'fa-sun', prefix: '#selectbless' }
];

let modData = { metadata: [] };
CATEGORIES.forEach(c => { if(c.id !== 'metadata') modData[c.id] = []; });
let currentSelection = { catId: 'monster', item: null };

let cmdDocs = {};
let currentSuggestContext = null;

async function loadCmdDocs() {
    try {
        const response = await fetch('cmd.json');
        if (response.ok) { cmdDocs = await response.json(); }
    } catch (e) { console.log("No local cmd.json found"); }
}

// --- Tour Guide Class ---
class TourGuide {
    constructor() {
        this.currentStep = 0;
        this.storageKey = 'tour-finished-v1.6.3'; 
        this.steps = [
            { target: 'step-1', t_title: 'TOUR_1_T', t_desc: 'TOUR_1_D' },
            { target: 'step-2', t_title: 'TOUR_2_T', t_desc: 'TOUR_2_D' },
            { target: 'step-3', t_title: 'TOUR_3_T', t_desc: 'TOUR_3_D' },
            { target: 'step-4', t_title: 'TOUR_4_T', t_desc: 'TOUR_4_D' },
            { target: 'step-5', t_title: 'TOUR_5_T', t_desc: 'TOUR_5_D' }
        ];
    }
    start() {
        if (localStorage.getItem(this.storageKey) === 'true') return;
        document.getElementById('tour-overlay').style.display = 'block';
        document.getElementById('tour-tooltip').style.display = 'block';
        this.show();
    }
    show() {
        // Simple positioning logic for tour
        const step = this.steps[this.currentStep];
        let el = null;
        
        // Map abstract steps to real IDs based on current view
        if(this.currentStep === 0) el = document.querySelector('.activity-bar');
        if(this.currentStep === 1) el = document.getElementById('view-sidebar');
        if(this.currentStep === 2) el = document.getElementById('view-list');
        if(this.currentStep === 3) el = document.getElementById('previewPanel');
        if(this.currentStep === 4) el = document.querySelector('.sidebar footer') || document.getElementById('view-sidebar');

        // Force elements visible for tour if hidden on desktop
        if(el && el.classList.contains('desktop-hidden')) el.classList.remove('desktop-hidden');

        const tooltip = document.getElementById('tour-tooltip');
        
        document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
        if(el) el.classList.add('tour-highlight'); 
        
        document.getElementById('tour-title').innerText = t(step.t_title);
        document.getElementById('tour-desc').innerText = t(step.t_desc);
        document.getElementById('tour-count').innerText = `${this.currentStep + 1} / ${this.steps.length}`;
        
        const rect = el ? el.getBoundingClientRect() : { top: 100, left: 100, bottom: 200, right: 200 };
        let top = rect.bottom + 10;
        let left = 20;
        
        // Adjust tour position
        if (window.innerWidth <= 768) {
            top = 100; left = (window.innerWidth - 280) / 2; 
        } else {
             if (rect.right + 300 < window.innerWidth) left = rect.right + 20;
             else left = rect.left - 300;
             top = rect.top + 20;
        }
        
        // Boundary check
        if(left < 0) left = 10;
        if(top > window.innerHeight - 150) top = window.innerHeight - 200;

        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
    }
    next() {
        this.currentStep++;
        if (this.currentStep < this.steps.length) { this.show(); } else { this.finish(); }
    }
    finish() {
        this.end();
        showAbout();
    }
    end() {
        document.getElementById('tour-overlay').style.display = 'none';
        document.getElementById('tour-tooltip').style.display = 'none';
        document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
        localStorage.setItem(this.storageKey, 'true');
    }
}

const tour = new TourGuide();

function showAbout() {
    const content = `<div style="text-align:center; padding:20px;"><i class="fa-solid fa-rocket" style="font-size:40px; color:#007acc; margin-bottom:15px;"></i><h3 style="color:#fff; margin-bottom:10px;">Dominions Mod Studio</h3><p style="color:#aaa; line-height:1.6;">v1.6.3<br>By: Mr.Pldada(2096358571@qq.com)</p><div style="margin: 15px 0; background: #fff; padding: 5px; display: inline-block; border-radius: 4px;"><img src="sk.jpg" alt="Donate" style="width: 300px; height: 300px; display: block;"></div><div style="margin-top:10px;"><a href="https://ko-fi.com/pldada" target="_blank" class="btn-kofi" style="width:auto; display:inline-flex; padding:6px 12px;"><i class="fa-solid fa-mug-hot"></i> Support on Ko-fi</a></div></div>`;
    openModal(t('DLG_ABOUT'), content, `<button class="btn-secondary" onclick="closeModal()">${t('BTN_CLOSE')}</button>`);
}
function showDonate() {
    const content = `<div style="text-align:center; padding:20px;"><h3 style="color:#fff; margin-bottom:15px;">${t('TXT_DONATE_MSG')}</h3><div style="margin: 15px 0; background: #fff; padding: 10px; display: inline-block; border-radius: 4px;"><img src="sk.jpg" alt="Donate" style="width: 300px; height: 300px; display: block;"></div><div style="margin-top:15px;"><a href="https://ko-fi.com/pldada" target="_blank" class="btn-kofi"><i class="fa-solid fa-mug-hot"></i> ${t('BTN_KOFI')}</a></div></div>`;
    openModal(t('DLG_DONATE'), content, `<button class="btn-secondary" onclick="closeModal()">${t('BTN_CLOSE')}</button>`);
}

// --- Logic ---
function showSuggestions(el, cmdObj, isMeta) {
    const val = el.value.toLowerCase();
    const widget = document.getElementById('suggestWidget');
    if (val.length === 0) { hideSuggestions(); return; }
    const matches = Object.entries(cmdDocs).filter(([cmd, desc]) => {
        return cmd.toLowerCase().includes(val) || (desc && desc.toLowerCase().includes(val));
    });
    if (matches.length > 0) {
        const rect = el.getBoundingClientRect();
        widget.style.top = (rect.bottom + window.scrollY) + 'px';
        widget.style.left = rect.left + 'px';
        widget.style.display = 'block';
        widget.innerHTML = matches.slice(0, 30).map(([m, d]) => `<div class="vsc-suggest-item" onclick="applySuggestion('${m}', ${isMeta})"><span class="vsc-suggest-label">${m}</span><span class="vsc-suggest-desc">${d || ''}</span></div>`).join('');
        currentSuggestContext = { el, cmdObj };
    } else { hideSuggestions(); }
}
function applySuggestion(cmd, isMeta) {
    if (currentSuggestContext) {
        currentSuggestContext.el.value = cmd;
        currentSuggestContext.cmdObj.cmd = cmd;
        const infoDiv = currentSuggestContext.el.parentElement.querySelector('.cmd-info');
        if (infoDiv) { const desc = cmdDocs[cmd] || ""; infoDiv.innerText = desc; infoDiv.style.display = desc ? "block" : "none"; }
        updatePreview(isMeta); hideSuggestions();
    }
}
function hideSuggestions() { document.getElementById('suggestWidget').style.display = 'none'; }

function openModal(header, contentHtml, footerHtml) {
    document.getElementById('modalHeader').innerText = header;
    document.getElementById('modalBody').innerHTML = contentHtml;
    document.getElementById('modalFooter').innerHTML = footerHtml || '';
    document.getElementById('vscModalOverlay').style.display = 'flex';
}
function closeModal() { document.getElementById('vscModalOverlay').style.display = 'none'; }
function customConfirm(message, onConfirm) {
    const content = `<p>${message}</p>`;
    const footer = `<button class="btn-new-item" style="width:auto; padding:4px 16px;" id="modalBtnConfirm">${t('BTN_CONFIRM')}</button><button class="btn-secondary" onclick="closeModal()">${t('BTN_CANCEL')}</button>`;
    openModal(t('BTN_CONFIRM'), content, footer);
    document.getElementById('modalBtnConfirm').onclick = () => { onConfirm(); closeModal(); };
}
function showSettings() {
    const html = `<div style="display:flex; flex-direction:column; gap:10px;"><p style="font-size:12px; color:#aaa;">System</p><button class="btn-new-item" onclick="exportCmdDictionary()">${t('TXT_EXPORT_DICT')}</button></div>`;
    openModal(t('DLG_SETTINGS'), html, `<button class="btn-secondary" onclick="closeModal()">${t('BTN_CLOSE')}</button>`);
}
function exportCmdDictionary() {
    let cmds = {}; modData.metadata.forEach(m => { if(m.cmd && m.cmd !== 'raw') cmds[m.cmd] = ""; });
    CATEGORIES.forEach(cat => { if(cat.id === 'metadata' || cat.id === 'god') return; modData[cat.id].forEach(item => { if(item.header.cmd) cmds[item.header.cmd] = ""; item.commands.forEach(c => { if(c.cmd && c.cmd !== 'raw') cmds[c.cmd] = ""; }); }); });
    const blob = new Blob([JSON.stringify(cmds, null, 4)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "cmd.json"; a.click();
}

function parseText(text) {
    CATEGORIES.forEach(c => modData[c.id] = []); modData.metadata = [];
    const lines = text.split(/\r?\n/); let currentObj = null; let pendingLongString = null;
    for (let line of lines) {
        const trimmed = line.trim();
        if (pendingLongString) { pendingLongString.value += "\n" + line; if (trimmed.endsWith('"')) pendingLongString = null; continue; }
        if (!trimmed || trimmed.startsWith('--')) {
            const targetArr = currentObj ? currentObj.commands : modData.metadata; const lastItem = targetArr[targetArr.length - 1];
            if (lastItem && lastItem.cmd === 'raw') { lastItem.value += "\n" + line; } else { targetArr.push({ cmd: 'raw', value: line }); } continue;
        }
        const parts = trimmed.split(/[\s\t]+/); const cmd = parts[0].toLowerCase();
        let rest = trimmed.substring(parts[0].length).trim(); let comment = "";
        const cIdx = rest.indexOf('--'); if (cIdx !== -1) { comment = rest.substring(cIdx + 2).trim(); rest = rest.substring(0, cIdx).trim(); }
        if (cmd.startsWith('#new') || cmd.startsWith('#select')) {
            let type = CATEGORIES.find(c => cmd.includes(c.id))?.id || 'monster';
            currentObj = { type, id: rest, name: '', header: { cmd, value: rest, comment }, commands: [] }; modData[type].push(currentObj); continue;
        }
        if (cmd === '#end') { currentObj = null; continue; }
        const cmdObj = { cmd, value: rest, comment }; if (rest.startsWith('"') && !rest.endsWith('"')) pendingLongString = cmdObj;
        if (currentObj) { currentObj.commands.push(cmdObj); if (cmd === '#name') currentObj.name = rest.replace(/"/g, ''); } else { modData.metadata.push(cmdObj); }
    }
    refreshGods(); updateStats(); renderTree();
}
function refreshGods() { modData['god'] = []; (modData['nation'] || []).forEach(nat => { nat.commands.filter(c => c.cmd === '#addgod').forEach(c => { const god = modData['monster'].find(m => m.id == c.value.trim()); if (god && !modData['god'].includes(god)) modData['god'].push(god); }); }); }
function renderTree() {
    const tree = document.getElementById('mainTree'); tree.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const div = document.createElement('div'); div.className = `tree-row ${currentSelection.catId === cat.id ? 'selected' : ''}`;
        div.innerHTML = `<span class="tree-icon"><i class="fa-solid ${cat.icon}"></i></span><span>${t(cat.i18n)}</span>`;
        div.onclick = () => { 
            currentSelection.catId = cat.id; renderTree(); renderList(); 
            if(window.innerWidth <= 768) switchViewMobile('list'); 
            // Desktop: Ensure lists are visible if they were hidden
            if(window.innerWidth > 768) {
                document.getElementById('view-list').classList.remove('desktop-hidden');
                document.getElementById('act-icon-list').classList.add('active');
            }
        };
        tree.appendChild(div);
    });
}
function renderList() {
    const list = document.getElementById('entryList'); list.innerHTML = '';
    document.getElementById('listTitle').innerText = t(CATEGORIES.find(c=>c.id===currentSelection.catId)?.i18n || 'HDR_EXPLORER');
    const items = currentSelection.catId === 'metadata' ? [{id:'META', name:t('CAT_META'), isMeta:true}] : (modData[currentSelection.catId] || []);
    items.forEach((item, idx) => {
        const div = document.createElement('div'); div.className = `entry-item ${currentSelection.item === item ? 'active' : ''}`;
        let displayName = item.name;
        if (!displayName && item.type === 'event') { const msgCmd = item.commands.find(c => c.cmd === '#msg'); if (msgCmd) displayName = msgCmd.value.replace(/"/g, ''); }
        if (!displayName && item.header && item.header.comment) { displayName = item.header.comment; }
        if (!displayName) displayName = item.isMeta ? (currentLang === 'cn' ? "全局元信息" : "Mod Meta") : t('TXT_UNTITLED');
        div.innerHTML = `<span class="entry-id">${item.id || ''}</span><span class="entry-name" title="${displayName}">${displayName}</span><div class="entry-actions"><i class="fa-solid fa-copy btn-icon" onclick="duplicateItem(event, '${currentSelection.catId}', ${idx})"></i><i class="fa-solid fa-trash-can btn-icon del" onclick="removeItem(event, '${currentSelection.catId}', ${idx})"></i></div>`;
        div.onclick = () => { 
            item.isMeta ? loadMetadata() : loadItem(item); 
            if(window.innerWidth <= 768) switchViewMobile('editor'); 
        };
        list.appendChild(div);
    });
    if (currentSelection.item) scrollToActive();
}
function loadMetadata() { currentSelection.item = { isMeta: true }; renderList(); const view = document.getElementById('formView'); view.innerHTML = `<h3>${t('CAT_META')}</h3>`; modData.metadata.forEach((cmd, idx) => { if (cmd.cmd === 'raw') view.appendChild(buildRawRow(cmd, idx, true)); else view.appendChild(buildRow(cmd, idx, false, true)); }); const addBtn = document.createElement('button'); addBtn.className = "btn-new-item"; addBtn.style.marginTop = "20px"; addBtn.innerHTML = `<i class='fa-solid fa-plus'></i> ${t('BTN_ADD_TAG')}`; addBtn.onclick = showMetaSelector; view.appendChild(addBtn); updatePreview(true); }
function loadItem(item) { currentSelection.item = item; renderList(); const view = document.getElementById('formView'); view.innerHTML = ''; view.appendChild(buildRow(item.header, -1, true)); item.commands.forEach((cmd, idx) => { if (cmd.cmd === 'raw') view.appendChild(buildRawRow(cmd, idx)); else view.appendChild(buildRow(cmd, idx)); }); const addBtn = document.createElement('button'); addBtn.className = "btn-new-item"; addBtn.style.marginTop = "20px"; addBtn.innerHTML = `<i class='fa-solid fa-plus'></i> ${t('BTN_ADD_PROP')}`; addBtn.onclick = () => { item.commands.push({ cmd: "#", value: "", comment: "" }); loadItem(item); }; view.appendChild(addBtn); updatePreview(); }

function buildRow(cmdObj, idx, isHeader = false, isMeta = false) {
    const row = document.createElement('div'); row.className = 'form-row';
    const desc = cmdDocs[cmdObj.cmd] || "";
    row.innerHTML = `<input class="lbl" value="${cmdObj.cmd}"><div><textarea class="auto-textarea" rows="1">${cmdObj.value}</textarea><div class="cmd-info" style="${desc ? 'display:block' : ''}">${desc}</div><input class="inp-comment" value="${cmdObj.comment}" placeholder="${t('PH_COMMENT')}"></div><div class="row-actions"><i class="fa-solid fa-plus btn-action add" onclick="insertRow(${idx}, ${isMeta})"></i>${!isHeader ? `<i class="fa-solid fa-trash-can btn-action del" onclick="deleteProp(${idx}, ${isMeta})"></i>` : ''}</div>`;
    const cmdInp = row.querySelector('.lbl'); const valArea = row.querySelector('.auto-textarea'); const comInp = row.querySelector('.inp-comment'); const infoDiv = row.querySelector('.cmd-info');
    cmdInp.oninput = (e) => { cmdObj.cmd = e.target.value; const newDesc = cmdDocs[cmdObj.cmd] || ""; infoDiv.innerText = newDesc; infoDiv.style.display = newDesc ? "block" : "none"; showSuggestions(e.target, cmdObj, isMeta); updatePreview(isMeta); };
    cmdInp.onclick = (e) => e.stopPropagation();
    valArea.oninput = (e) => { cmdObj.value = e.target.value; if(isHeader) currentSelection.item.id = e.target.value; if((cmdObj.cmd === '#name' || (currentSelection.item && currentSelection.item.type === 'event' && cmdObj.cmd === '#msg')) && currentSelection.item) { if(cmdObj.cmd === '#name') currentSelection.item.name = e.target.value.replace(/"/g, ''); renderList(); } autoResize(valArea); updatePreview(isMeta); };
    comInp.oninput = (e) => { cmdObj.comment = e.target.value; if(isHeader) renderList(); updatePreview(isMeta); };
    setTimeout(() => autoResize(valArea), 0); return row;
}
function buildRawRow(cmd, idx, isMeta = false) { const row = document.createElement('div'); row.className = 'form-row'; row.innerHTML = `<div class="lbl" style="opacity:0.2">--</div><textarea class="auto-textarea" style="color:var(--sh-comment); border:none; background:none;">${cmd.value}</textarea><div class="row-actions"><i class="fa-solid fa-plus btn-action add" onclick="insertRow(${idx}, ${isMeta})"></i><i class="fa-solid fa-trash-can btn-action del" onclick="deleteProp(${idx}, ${isMeta})"></i></div>`; const area = row.querySelector('textarea'); area.oninput = (e) => { cmd.value = e.target.value; autoResize(area); updatePreview(isMeta); }; setTimeout(() => autoResize(area), 0); return row; }
function insertRow(idx, isMeta) { const target = isMeta ? modData.metadata : currentSelection.item.commands; target.splice(idx + 1, 0, { cmd: "#", value: "", comment: "" }); isMeta ? loadMetadata() : loadItem(currentSelection.item); }
function deleteProp(idx, isMeta) { customConfirm(t('MSG_DEL_ROW'), () => { if (isMeta) modData.metadata.splice(idx, 1); else currentSelection.item.commands.splice(idx, 1); isMeta ? loadMetadata() : loadItem(currentSelection.item); }); }
function createNewItem() { const cat = CATEGORIES.find(c => c.id === currentSelection.catId); if (!cat || cat.id === 'god') return; if (cat.id === 'metadata') { addMetaTag('#modname'); return; } const newItem = { type: cat.id, id: "999", name: "New Item", header: { cmd: cat.prefix, value: "999", comment: "" }, commands: [{ cmd: "#name", value: '"New Item"', comment: "" }] }; modData[cat.id].unshift(newItem); renderList(); loadItem(newItem); updateStats(); }
function duplicateItem(e, cat, idx) { e.stopPropagation(); const original = modData[cat][idx]; const copy = JSON.parse(JSON.stringify(original)); if (copy.name) copy.name += " (Copy)"; const nameCmd = copy.commands.find(c => c.cmd === '#name'); if (nameCmd) nameCmd.value = `"${copy.name}"`; modData[cat].splice(idx + 1, 0, copy); renderList(); updateStats(); }
function updatePreview(isMeta = false) { const item = currentSelection.item; if(!item) return; let code = ""; const span = (t, c) => `<span class="${c}">${t}</span>`; if (isMeta) { modData.metadata.forEach(c => { if(c.cmd === 'raw') code += span(c.value, 'tok-com') + "\n"; else code += `${span(c.cmd, 'tok-cmd')} ${span(c.value, 'tok-val')}${c.comment ? ' ' + span('-- '+c.comment, 'tok-com') : ''}\n`; }); } else { code += `${span(item.header.cmd, 'tok-kw')} ${span(item.header.value, 'tok-val')}${item.header.comment ? ' ' + span('-- '+item.header.comment, 'tok-com') : ''}\n`; item.commands.forEach(c => { if(c.cmd === 'raw') code += span(c.value, 'tok-com') + "\n"; else code += `  ${span(c.cmd, 'tok-cmd')} ${span(c.value, 'tok-val')}${c.comment ? ' ' + span('-- '+c.comment, 'tok-com') : ''}\n`; }); code += span('#end', 'tok-kw'); } document.getElementById('codePreview').innerHTML = code; }
function updateStats() { let total = 0; CATEGORIES.forEach(c => { if(c.id !== 'metadata') total += (modData[c.id]?.length || 0); }); const content = document.getElementById('statsContent'); content.innerHTML = ''; CATEGORIES.forEach(c => { if(c.id === 'metadata') return; const count = modData[c.id]?.length || 0; const percentage = total > 0 ? (count / total) * 100 : 0; content.innerHTML += `<div class="stat-box"><div style="font-size:11px; color:#888">${t(c.i18n)}</div><div style="font-size:18px; font-weight:bold">${count}</div><div class="stat-bar-outer"><div class="stat-bar-inner" style="width:${percentage}%"></div></div></div>`; }); document.getElementById('objCount').innerText = t('TXT_TOTAL') + ": " + total; }
function toggleBottomPanel() { const p = document.getElementById('bottomPanel'); p.style.height = p.style.height === '180px' ? '0' : '180px'; if(p.style.height === '180px') updateStats(); }
function exportFile() { let out = ""; modData.metadata.forEach(m => out += (m.cmd==='raw'? m.value : `${m.cmd} ${m.value}${m.comment?' -- '+m.comment:''}`) + "\n"); CATEGORIES.forEach(cat => { if(['metadata','god'].includes(cat.id)) return; (modData[cat.id]||[]).forEach(item => { out += `\n${item.header.cmd} ${item.header.value}${item.header.comment?' -- '+item.header.comment:''}\n`; item.commands.forEach(c => out += (c.cmd==='raw' ? c.value : `  ${c.cmd} ${c.value}${c.comment?' -- '+c.comment:''}`) + "\n"); out += "#end\n"; }); }); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([out], {type: "text/plain"})); a.download = "mod_export.dm"; a.click(); }
function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
function copyPreview() { navigator.clipboard.writeText(document.getElementById('codePreview').innerText); }
function loadFile(input) { const reader = new FileReader(); reader.onload = (e) => parseText(e.target.result); reader.readAsText(input.files[0]); }
function filterItems() { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.entry-item').forEach(el => { el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }); }
function removeItem(e, cat, idx) { e.stopPropagation(); customConfirm(`${t('MSG_DEL_CONFIRM')} (${modData[cat][idx].name || t('TXT_UNTITLED')}) ?`, () => { modData[cat].splice(idx, 1); renderList(); updateStats(); }); }
function scrollToActive() { setTimeout(() => { const activeItem = document.querySelector('.entry-item.active'); if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50); }
function showMetaSelector() { const options = [{t:'#modname',d:'Mod Name'}, {t:'#description',d:'Desc'}, {t:'#icon',d:'Icon'}, {t:'#version',d:'Ver'}, {t:'#domversion',d:'Game Ver'}]; let listHtml = '<div class="vsc-list">'; options.forEach(opt => { listHtml += `<div class="vsc-list-item" onclick="addMetaTag('${opt.t}')">${opt.t} <span style="color:#666">(${opt.d})</span></div>`; }); listHtml += '</div>'; openModal("Select Tag", listHtml, `<button class="btn-secondary" onclick="closeModal()">${t('BTN_CANCEL')}</button>`); }
function addMetaTag(tag) { modData.metadata.push({ cmd: tag, value: tag === '#modname' ? '"New Mod"' : '', comment: "" }); closeModal(); loadMetadata(); }

document.addEventListener('DOMContentLoaded', () => { 
    updateInterfaceText();
    loadCmdDocs();
    setTimeout(() => tour.start(), 1000); 
});
</script>
</body>
</html>