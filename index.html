<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions Mod Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-sidebar: #252526; --bg-activity: #333333;
            --bg-input: #3c3c3c; --bg-hover: #2a2d2e; --bg-selection: #37373d;
            --border-color: #454545; --accent-color: #007acc;
            --text-main: #cccccc; --text-muted: #858585; --text-header: #e7e7e7;
            --sh-cmd: #569cd6; --sh-val: #ce9178; --sh-comment: #6a9955; --sh-key: #9cdcfe;
            --font-code: "JetBrains Mono", "Consolas", monospace;
            --font-ui: "Segoe UI", "Microsoft YaHei", sans-serif;
            --radius: 2px;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg-main); color: var(--text-main); font-family: var(--font-ui); font-size: 13px; display: flex; height: 100vh; overflow: hidden; }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #424242; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }

        .activity-bar { width: 48px; background: var(--bg-activity); display: flex; flex-direction: column; justify-content: space-between; flex-shrink: 0; }
        .activity-icon { width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.6; color: #fff; font-size: 20px; transition: 0.2s; border-left: 2px solid transparent; }
        .activity-icon:hover { opacity: 1; }
        .activity-icon.active { opacity: 1; border-left-color: #fff; background: var(--bg-sidebar); }

        .sidebar { width: 260px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; flex-shrink: 0; }
        .sidebar-header { padding: 0 12px; height: 35px; display: flex; align-items: center; font-size: 11px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid #111; }
        
        .tree-view { overflow-y: auto; flex: 1; }
        .tree-row { display: flex; align-items: center; padding: 6px 12px; white-space: nowrap; cursor: pointer; border-left: 2px solid transparent; transition: 0.1s; }
        .tree-row:hover { background: var(--bg-hover); }
        .tree-row.selected { background: var(--bg-selection); border-left-color: var(--accent-color); color: #fff; }
        .tree-icon { width: 22px; text-align: center; margin-right: 8px; font-size: 14px; }
        
        .list-panel { width: 300px; background: var(--bg-sidebar); border-right: 1px solid #111; display: flex; flex-direction: column; }
        .list-header { padding: 10px; background: #2d2d2d; border-bottom: 1px solid #111; display: flex; flex-direction: column; gap: 8px; }
        .search-input { width: 100%; background: var(--bg-input); border: 1px solid transparent; color: #fff; padding: 6px 8px; font-size: 12px; }
        .search-input:focus { border-color: var(--accent-color); }
        
        .btn-new-item { width: 100%; padding: 6px; background: var(--accent-color); color: white; border: none; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 2px; }
        .btn-new-item:hover { background: #1a8ad4; }

        .entry-list { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        .entry-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #2a2a2a; }
        .entry-item:hover { background: var(--bg-hover); }
        .entry-item.active { background: #094771; }
        .entry-id { color: var(--sh-val); width: 45px; font-family: var(--font-code); font-size: 11px; }
        .entry-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .entry-actions { display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
        .entry-item:hover .entry-actions { opacity: 1; }
        .btn-icon { color: #888; cursor: pointer; padding: 2px; font-size: 12px; }
        .btn-icon:hover { color: #fff; }
        .btn-icon.del:hover { color: #f44336; }

        .editor-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); overflow: hidden; }
        .editor-split { flex: 1; display: flex; overflow: hidden; }
        .form-view { flex: 1; padding: 20px; overflow-y: auto; }
        
        .form-row { display: grid; grid-template-columns: 160px 1fr 70px; gap: 12px; margin-bottom: 8px; padding: 4px; border-radius: var(--radius); }
        .form-row:hover { background: #2a2d2e; }
        .lbl { text-align: right; color: var(--sh-key); font-family: var(--font-code); padding-top: 6px; font-weight: 500; font-size: 12px; background: none; border: none; }
        
        .auto-textarea { 
            background: var(--bg-input); border: 1px solid transparent; color: var(--text-main); 
            font-family: var(--font-code); padding: 8px 10px; width: 100%; resize: none; overflow: hidden;
            line-height: 1.5; font-size: 13px;
        }
        .auto-textarea:focus { border-color: var(--accent-color); outline: none; }
        .inp-comment { background: transparent; border: none; color: var(--sh-comment); font-size: 11px; font-style: italic; width: 100%; font-family: var(--font-code); margin-top: 4px; }

        .cmd-info { font-size: 11px; color: #aaa; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 2px; margin-top: 4px; border-left: 2px solid var(--accent-color); display: none; }

        .row-actions { display: flex; gap: 8px; padding-top: 6px; justify-content: flex-end; opacity: 0; }
        .form-row:hover .row-actions { opacity: 1; }
        .btn-action { cursor: pointer; font-size: 14px; color: #858585; }
        .btn-action:hover { color: #fff; }

        .preview-view { width: 420px; background: #1e1e1e; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .code-content { flex: 1; padding: 15px; overflow: auto; font-family: var(--font-code); font-size: 12px; white-space: pre-wrap; color: #d4d4d4; line-height: 1.6; }
        
        .tok-cmd { color: var(--sh-cmd); font-weight: bold; }
        .tok-val { color: var(--sh-val); }
        .tok-com { color: var(--sh-comment); }
        .tok-kw { color: #c586c0; font-weight: bold; }

        #bottomPanel { height: 0; overflow: hidden; background: #252526; border-top: 1px solid #333; transition: 0.2s; }
        .stats-grid { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; }
        .stat-box { background: #333; padding: 10px; min-width: 140px; border-radius: 4px; }
        .stat-bar-outer { height: 4px; background: #444; margin-top: 8px; width: 100%; border-radius: 2px; overflow: hidden; }
        .stat-bar-inner { height: 100%; background: var(--accent-color); width: 0%; transition: 0.4s ease-out; }

        .status-bar { height: 22px; background: var(--accent-color); color: #fff; display: flex; align-items: center; padding: 0 10px; font-size: 11px; justify-content: space-between; }
        
        .vsc-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 10000;
            display: none; justify-content: center; align-items: flex-start;
            padding-top: 50px;
        }
        .vsc-modal {
            background: #252526; border: 1px solid #454545; width: 450px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        .vsc-modal-header { padding: 8px 12px; font-weight: bold; font-size: 11px; color: #969696; background: #2d2d2d; }
        .vsc-modal-body { padding: 15px; font-size: 13px; color: #cccccc; }
        .vsc-modal-footer { padding: 8px 12px; display: flex; justify-content: flex-end; gap: 8px; background: #2d2d2d; }
        
        .btn-secondary { background: #3e3e42; color: #fff; border: none; padding: 4px 12px; cursor: pointer; font-size: 12px; }
        .btn-secondary:hover { background: #4e4e52; }
        
        .vsc-list { display: flex; flex-direction: column; max-height: 300px; overflow-y: auto; }
        .vsc-list-item { padding: 8px 12px; cursor: pointer; font-size: 12px; border-radius: 2px; }
        .vsc-list-item:hover { background: #094771; color: #fff; }

        .vsc-suggest-widget {
            position: fixed; background: #252526; border: 1px solid #454545;
            z-index: 30000; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none; max-height: 250px; overflow-y: auto; width: 320px;
        }
        .vsc-suggest-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 2px; }
        .vsc-suggest-item:hover { background: #094771; }
        .vsc-suggest-label { font-family: var(--font-code); font-weight: bold; color: var(--sh-cmd); font-size: 12px; }
        .vsc-suggest-desc { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .vsc-suggest-item:hover .vsc-suggest-desc { color: #ccc; }

        /* --- Tour Guide Styles (Fixed Z-Index) --- */
        #tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 40000; display: none; }
        #tour-tooltip { position: fixed; z-index: 40002; background: #252526; color: #fff; padding: 15px; border-radius: 4px; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #454545; display: none; }
        .tour-highlight { position: relative; z-index: 40001 !important; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); pointer-events: none; }
        #tour-title { margin-top:0; color:var(--accent-color); font-size:14px; font-weight:bold; }
        #tour-desc { color:#cccccc; font-size:13px; line-height:1.5; margin:10px 0; }
    </style>
</head>
<body onclick="hideSuggestions()">

    <div id="vscModalOverlay" class="vsc-modal-overlay">
        <div class="vsc-modal">
            <div id="modalHeader" class="vsc-modal-header">MODAL</div>
            <div id="modalBody" class="vsc-modal-body"></div>
            <div id="modalFooter" class="vsc-modal-footer"></div>
        </div>
    </div>

    <!-- Tour Elements -->
    <div id="tour-overlay"></div>
    <div id="tour-tooltip">
        <div id="tour-title"></div>
        <div id="tour-desc"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-secondary" onclick="tour.end()">跳过</button>
            <div style="display:flex; gap:10px; align-items:center">
                <span id="tour-count" style="font-size:11px; color:#888"></span>
                <button class="btn-new-item" style="width:auto; padding:4px 12px;" onclick="tour.next()" id="tour-btn-next">下一步</button>
            </div>
        </div>
    </div>

    <!-- Suggestion Widget -->
    <div id="suggestWidget" class="vsc-suggest-widget"></div>

    <div class="activity-bar" id="step-1">
        <div class="activity-top">
            <div class="activity-icon active"><i class="fa-regular fa-file-lines"></i></div>
            <div class="activity-icon" onclick="toggleBottomPanel()"><i class="fa-solid fa-chart-pie"></i></div>
        </div>
        <div class="activity-bottom">
            <!-- New Buttons -->
            <div class="activity-icon" onclick="showDonate()" title="捐赠"><i class="fa-solid fa-heart"></i></div>
            <div class="activity-icon" onclick="showAbout()" title="关于"><i class="fa-solid fa-circle-info"></i></div>
            <div class="activity-icon" onclick="showSettings()" title="设置"><i class="fa-solid fa-gear"></i></div>
        </div>
    </div>

    <div class="sidebar" id="step-2">
        <div class="sidebar-header">资源管理器</div>
        <div class="tree-view" id="mainTree"></div>
        <div style="padding: 10px; border-top: 1px solid #333; display:flex; gap:5px;" id="step-5">
            <button class="auto-textarea" style="cursor:pointer; text-align:center; font-size:11px;" onclick="document.getElementById('fileInput').click()">导入 DM</button>
            <button class="auto-textarea" style="background:var(--accent-color); cursor:pointer; text-align:center; font-size:11px;" onclick="exportFile()">导出 MOD</button>
            <input type="file" id="fileInput" accept=".txt,.dm" style="display:none" onchange="loadFile(this)">
        </div>
    </div>

    <div class="list-panel" id="step-3">
        <div class="list-header">
            <button class="btn-new-item" onclick="createNewItem()"><i class="fa-solid fa-plus"></i> 新增项目</button>
            <input type="text" class="search-input" id="searchInput" placeholder="搜索条目..." onkeyup="filterItems()">
        </div>
        <div class="entry-list" id="entryList"></div>
    </div>

    <div class="editor-container">
        <div class="editor-split">
            <div class="form-view" id="formView">
                <div style="height:100%; display:flex; align-items:center; justify-content:center; color:#555; flex-direction:column;">
                    <i class="fa-solid fa-code" style="font-size:60px; margin-bottom:20px;"></i>
                    <p>选择一个分类开始构建 Mod</p>
                </div>
            </div>
            <div class="preview-view" id="step-4">
                <div style="padding:8px 12px; font-size:11px; color:var(--text-muted); background:#252526; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                    <span>实时预览 (Read-Only)</span>
                    <i class="fa-regular fa-copy" style="cursor:pointer" onclick="copyPreview()" title="复制代码"></i>
                </div>
                <div class="code-content" id="codePreview"></div>
            </div>
        </div>
        
        <div id="bottomPanel">
            <div class="stats-grid" id="statsContent"></div>
        </div>

        <div class="status-bar">
            <div id="statusMsg">就绪</div>
            <div style="display:flex; gap:15px;">
                <span id="objCount">总计: 0</span>
                <span>Dominions  Mod Studio v1.5</span>
            </div>
        </div>
    </div>

<script>
// --- State & Config ---
const CATEGORIES = [
    { id: 'metadata', label: 'Mod 元信息', icon: 'fa-gears', prefix: '#modname' },
    { id: 'monster', label: '单位 (Monsters)', icon: 'fa-dragon', prefix: '#newmonster' },
    { id: 'nation', label: '国家 (Nations)', icon: 'fa-flag', prefix: '#newnation' },
    { id: 'god', label: '准神 (Gods)', icon: 'fa-hand-fist' },
    { id: 'spell', label: '法术 (Spells)', icon: 'fa-wand-sparkles', prefix: '#newspell' },
    { id: 'armor', label: '防具 (Armor)', icon: 'fa-shield-halved', prefix: '#newarmor' },
    { id: 'weapon', label: '武器 (Weapons)', icon: 'fa-hammer', prefix: '#newweapon' },
    { id: 'site', label: '遗迹 (Sites)', icon: 'fa-dungeon', prefix: '#newsite' },
    { id: 'item', label: '物品 (Items)', icon: 'fa-gem', prefix: '#newitem' },
    { id: 'nametype', label: '命名 (Names)', icon: 'fa-signature', prefix: '#selectnametype' },
    { id: 'event', label: '事件 (Events)', icon: 'fa-bolt', prefix: '#newevent' },
    { id: 'bless', label: '祝福 (Bless)', icon: 'fa-sun', prefix: '#selectbless' }
];

let modData = { metadata: [] };
CATEGORIES.forEach(c => { if(c.id !== 'metadata') modData[c.id] = []; });
let currentSelection = { catId: 'monster', item: null };

let cmdDocs = {};
let currentSuggestContext = null;

// --- Load Dictionary ---
async function loadCmdDocs() {
    try {
        const response = await fetch('cmd.json');
        if (response.ok) {
            cmdDocs = await response.json();
            console.log("已加载属性说明字典");
        }
    } catch (e) { console.log("未发现本地 cmd.json"); }
}

// --- Tour Guide Class ---
class TourGuide {
    constructor(config) {
        this.steps = config.steps;
        this.finalContent = config.final;
        this.currentStep = 0;
        this.storageKey = 'tour-finished-v5.4'; 
    }

    start() {
        if (localStorage.getItem(this.storageKey) === 'true') return;
        document.getElementById('tour-overlay').style.display = 'block';
        document.getElementById('tour-tooltip').style.display = 'block';
        this.show();
    }

    show() {
        const step = this.steps[this.currentStep];
        const el = document.getElementById(step.target);
        const tooltip = document.getElementById('tour-tooltip');
        const btnNext = document.getElementById('tour-btn-next');
        
        document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
        el.classList.add('tour-highlight');
        
        document.getElementById('tour-title').innerText = step.title;
        document.getElementById('tour-desc').innerText = step.desc;
        document.getElementById('tour-count').innerText = `${this.currentStep + 1} / ${this.steps.length}`;
        btnNext.innerText = this.currentStep === this.steps.length - 1 ? '完成' : '下一步';
        
        const rect = el.getBoundingClientRect();
        let top = rect.top;
        let left = rect.right + 20;

        if (left + 300 > window.innerWidth) left = rect.left - 300;
        if (top + 200 > window.innerHeight) top = window.innerHeight - 200;

        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
    }

    next() {
        this.currentStep++;
        if (this.currentStep < this.steps.length) {
            this.show();
        } else {
            this.finish();
        }
    }

    finish() {
        this.end();
        showAbout(); // Show about window which contains the final message
    }

    end() {
        document.getElementById('tour-overlay').style.display = 'none';
        document.getElementById('tour-tooltip').style.display = 'none';
        document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
        localStorage.setItem(this.storageKey, 'true');
    }
}

// Initialize Tour Instance
const tour = new TourGuide({
    steps: [
        { target: 'step-1', title: '多功能侧边栏', desc: '在这里切换不同的编辑视图，或打开底部的统计图表面板。' },
        { target: 'step-2', title: '对象分类', desc: '选择 Mod 的不同类别，如单位、国家或法术。点击分类可展开列表。' },
        { target: 'step-3', title: '条目列表', desc: '管理你的修改项。支持新增、删除以及复制条目。' },
        { target: 'step-4', title: '代码预览', desc: '实时查看生成的 .dm 代码，支持一键复制到剪贴板。' },
        { target: 'step-5', title: '导入与导出', desc: '支持导入现有的 Mod 文件进行编辑，完成后导出保存。' }
    ],
    final: {} // Content managed by showAbout() now
});

// --- About & Donate Modals ---
function showAbout() {
    const content = `
        <div style="text-align:center; padding:20px;">
            <i class="fa-solid fa-rocket" style="font-size:40px; color:#007acc; margin-bottom:15px;"></i>
            <h3 style="color:#fff; margin-bottom:10px;">Dominions Mod Studio</h3>
            <p style="color:#aaa; line-height:1.6;">
                当前版本：v1.5<br>
                开发者：Mr.Pldada(2096358571@qq.com)
            </p>
            <div style="margin: 15px 0; background: #fff; padding: 5px; display: inline-block; border-radius: 4px;">
                <img src="sk.jpg" alt="Donate" style="width: 350px; height: 350px; display: block;">
            </div>
            <p style="color:#aaa; font-size:12px;">支持开发者</p>
            <br>
            <p style="color:#aaa; line-height:1.6; font-size:12px;">
                祝您 Mod 制作愉快！
            </p>
        </div>
    `;
    openModal("关于", content, `<button class="btn-secondary" onclick="closeModal()">开始使用</button>`);
}

function showDonate() {
    const content = `
        <div style="text-align:center; padding:20px;">
            <h3 style="color:#fff; margin-bottom:15px;">感谢您的支持！</h3>
            <div style="margin: 15px 0; background: #fff; padding: 10px; display: inline-block; border-radius: 4px;">
                <img src="sk.jpg" alt="Donate" style="width: 350px; height: 350px; display: block;">
            </div>
            <p style="color:#aaa; font-size:13px;">您的支持是我更新的动力</p>
        </div>
    `;
    openModal("捐赠", content, `<button class="btn-secondary" onclick="closeModal()">关闭</button>`);
}

// --- IntelliSense Suggestion Logic ---
function showSuggestions(el, cmdObj, isMeta) {
    const val = el.value.toLowerCase();
    const widget = document.getElementById('suggestWidget');
    if (val.length === 0) { hideSuggestions(); return; }
    const matches = Object.entries(cmdDocs).filter(([cmd, desc]) => {
        return cmd.toLowerCase().includes(val) || desc.toLowerCase().includes(val);
    });
    if (matches.length > 0) {
        const rect = el.getBoundingClientRect();
        widget.style.top = (rect.bottom + window.scrollY) + 'px';
        widget.style.left = rect.left + 'px';
        widget.style.display = 'block';
        widget.innerHTML = matches.slice(0, 30).map(([m, d]) => `
            <div class="vsc-suggest-item" onclick="applySuggestion('${m}', ${isMeta})">
                <span class="vsc-suggest-label">${m}</span><span class="vsc-suggest-desc">${d || '无说明'}</span>
            </div>`).join('');
        currentSuggestContext = { el, cmdObj };
    } else { hideSuggestions(); }
}
function applySuggestion(cmd, isMeta) {
    if (currentSuggestContext) {
        currentSuggestContext.el.value = cmd;
        currentSuggestContext.cmdObj.cmd = cmd;
        const infoDiv = currentSuggestContext.el.parentElement.querySelector('.cmd-info');
        if (infoDiv) { const desc = cmdDocs[cmd] || ""; infoDiv.innerText = desc; infoDiv.style.display = desc ? "block" : "none"; }
        updatePreview(isMeta); hideSuggestions();
    }
}
function hideSuggestions() { document.getElementById('suggestWidget').style.display = 'none'; }

// --- VS Code Style Modal Logic ---
function openModal(header, contentHtml, footerHtml) {
    document.getElementById('modalHeader').innerText = header;
    document.getElementById('modalBody').innerHTML = contentHtml;
    document.getElementById('modalFooter').innerHTML = footerHtml || '';
    document.getElementById('vscModalOverlay').style.display = 'flex';
}
function closeModal() { document.getElementById('vscModalOverlay').style.display = 'none'; }
function customConfirm(message, onConfirm) {
    const content = `<p>${message}</p>`;
    const footer = `<button class="btn-new-item" style="width:auto; padding:4px 16px;" id="modalBtnConfirm">确认</button><button class="btn-secondary" onclick="closeModal()">取消</button>`;
    openModal("确认", content, footer);
    document.getElementById('modalBtnConfirm').onclick = () => { onConfirm(); closeModal(); };
}

function showSettings() {
    const html = `<div style="display:flex; flex-direction:column; gap:10px;"><p style="font-size:12px; color:#aaa;">系统管理功能</p><button class="btn-new-item" onclick="exportCmdDictionary()">导出当前 Mod 所有命令为字典 (JSON)</button><p style="font-size:11px; color:#666;">导出的 JSON 可放入程序根目录命名为 cmd.json，程序启动时会自动加载说明文字。</p></div>`;
    openModal("SETTINGS", html, `<button class="btn-secondary" onclick="closeModal()">关闭</button>`);
}

function exportCmdDictionary() {
    let cmds = {};
    modData.metadata.forEach(m => { if(m.cmd && m.cmd !== 'raw') cmds[m.cmd] = ""; });
    CATEGORIES.forEach(cat => {
        if(cat.id === 'metadata' || cat.id === 'god') return;
        modData[cat.id].forEach(item => {
            if(item.header.cmd) cmds[item.header.cmd] = "";
            item.commands.forEach(c => { if(c.cmd && c.cmd !== 'raw') cmds[c.cmd] = ""; });
        });
    });
    const blob = new Blob([JSON.stringify(cmds, null, 4)], {type: "application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "cmd.json"; a.click();
}

// --- Parser ---
function parseText(text) {
    CATEGORIES.forEach(c => modData[c.id] = []);
    modData.metadata = [];
    const lines = text.split(/\r?\n/);
    let currentObj = null;
    let pendingLongString = null;
    for (let line of lines) {
        const trimmed = line.trim();
        if (pendingLongString) { pendingLongString.value += "\n" + line; if (trimmed.endsWith('"')) pendingLongString = null; continue; }
        if (!trimmed || trimmed.startsWith('--')) {
            const targetArr = currentObj ? currentObj.commands : modData.metadata;
            const lastItem = targetArr[targetArr.length - 1];
            if (lastItem && lastItem.cmd === 'raw') { lastItem.value += "\n" + line; } else { targetArr.push({ cmd: 'raw', value: line }); }
            continue;
        }
        const parts = trimmed.split(/[\s\t]+/);
        const cmd = parts[0].toLowerCase();
        let rest = trimmed.substring(parts[0].length).trim();
        let comment = "";
        const cIdx = rest.indexOf('--');
        if (cIdx !== -1) { comment = rest.substring(cIdx + 2).trim(); rest = rest.substring(0, cIdx).trim(); }
        if (cmd.startsWith('#new') || cmd.startsWith('#select')) {
            let type = CATEGORIES.find(c => cmd.includes(c.id))?.id || 'monster';
            currentObj = { type, id: rest, name: '', header: { cmd, value: rest, comment }, commands: [] };
            modData[type].push(currentObj); continue;
        }
        if (cmd === '#end') { currentObj = null; continue; }
        const cmdObj = { cmd, value: rest, comment };
        if (rest.startsWith('"') && !rest.endsWith('"')) pendingLongString = cmdObj;
        if (currentObj) { currentObj.commands.push(cmdObj); if (cmd === '#name') currentObj.name = rest.replace(/"/g, ''); } 
        else { modData.metadata.push(cmdObj); }
    }
    refreshGods(); updateStats(); renderTree();
}

function refreshGods() {
    modData['god'] = [];
    (modData['nation'] || []).forEach(nat => {
        nat.commands.filter(c => c.cmd === '#addgod').forEach(c => {
            const god = modData['monster'].find(m => m.id == c.value.trim());
            if (god && !modData['god'].includes(god)) modData['god'].push(god);
        });
    });
}
function renderTree() {
    const tree = document.getElementById('mainTree'); tree.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const div = document.createElement('div');
        div.className = `tree-row ${currentSelection.catId === cat.id ? 'selected' : ''}`;
        div.innerHTML = `<span class="tree-icon"><i class="fa-solid ${cat.icon}"></i></span><span>${cat.label}</span>`;
        div.onclick = () => { currentSelection.catId = cat.id; renderTree(); renderList(); };
        tree.appendChild(div);
    });
}
function renderList() {
    const list = document.getElementById('entryList'); list.innerHTML = '';
    const items = currentSelection.catId === 'metadata' ? [{id:'META', name:'全局元信息配置', isMeta:true}] : (modData[currentSelection.catId] || []);
    items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = `entry-item ${currentSelection.item === item ? 'active' : ''}`;
        let displayName = item.name;
        if (!displayName && item.type === 'event') { const msgCmd = item.commands.find(c => c.cmd === '#msg'); if (msgCmd) displayName = msgCmd.value.replace(/"/g, ''); }
        if (!displayName && item.header && item.header.comment) { displayName = item.header.comment; }
        if (!displayName) displayName = item.isMeta ? item.name : '(未命名)';
        div.innerHTML = `
            <span class="entry-id">${item.id || ''}</span><span class="entry-name" title="${displayName}">${displayName}</span>
            <div class="entry-actions">
                <i class="fa-solid fa-copy btn-icon" title="复制" onclick="duplicateItem(event, '${currentSelection.catId}', ${idx})"></i>
                <i class="fa-solid fa-trash-can btn-icon del" title="删除" onclick="removeItem(event, '${currentSelection.catId}', ${idx})"></i>
            </div>
        `;
        div.onclick = () => item.isMeta ? loadMetadata() : loadItem(item);
        list.appendChild(div);
    });
    if (currentSelection.item) scrollToActive();
}

function loadMetadata() {
    currentSelection.item = { isMeta: true }; renderList();
    const view = document.getElementById('formView'); view.innerHTML = '<h3>全局元信息</h3>';
    modData.metadata.forEach((cmd, idx) => {
        if (cmd.cmd === 'raw') view.appendChild(buildRawRow(cmd, idx, true));
        else view.appendChild(buildRow(cmd, idx, false, true));
    });
    const addBtn = document.createElement('button'); addBtn.className = "btn-new-item"; addBtn.style.marginTop = "20px"; addBtn.innerHTML = "<i class='fa-solid fa-plus'></i> 添加元信息标签"; addBtn.onclick = showMetaSelector; view.appendChild(addBtn); updatePreview(true);
}
function loadItem(item) {
    currentSelection.item = item; renderList();
    const view = document.getElementById('formView'); view.innerHTML = '';
    view.appendChild(buildRow(item.header, -1, true));
    item.commands.forEach((cmd, idx) => { if (cmd.cmd === 'raw') view.appendChild(buildRawRow(cmd, idx)); else view.appendChild(buildRow(cmd, idx)); });
    const addBtn = document.createElement('button'); addBtn.className = "btn-new-item"; addBtn.style.marginTop = "20px"; addBtn.innerHTML = "<i class='fa-solid fa-plus'></i> 添加属性行"; addBtn.onclick = () => { item.commands.push({ cmd: "#", value: "", comment: "" }); loadItem(item); }; view.appendChild(addBtn); updatePreview();
}

function buildRow(cmdObj, idx, isHeader = false, isMeta = false) {
    const row = document.createElement('div'); row.className = 'form-row';
    const desc = cmdDocs[cmdObj.cmd] || "";
    row.innerHTML = `
        <input class="lbl" value="${cmdObj.cmd}">
        <div>
            <textarea class="auto-textarea" rows="1">${cmdObj.value}</textarea>
            <div class="cmd-info" style="${desc ? 'display:block' : ''}">${desc}</div>
            <input class="inp-comment" value="${cmdObj.comment}" placeholder="-- 注释">
        </div>
        <div class="row-actions">
            <i class="fa-solid fa-plus btn-action" onclick="insertRow(${idx}, ${isMeta})"></i>
            ${!isHeader ? `<i class="fa-solid fa-trash-can btn-action" onclick="deleteProp(${idx}, ${isMeta})"></i>` : ''}
        </div>
    `;
    const cmdInp = row.querySelector('.lbl'); const valArea = row.querySelector('.auto-textarea'); const comInp = row.querySelector('.inp-comment'); const infoDiv = row.querySelector('.cmd-info');
    cmdInp.oninput = (e) => { 
        cmdObj.cmd = e.target.value; const newDesc = cmdDocs[cmdObj.cmd] || ""; infoDiv.innerText = newDesc; infoDiv.style.display = newDesc ? "block" : "none";
        showSuggestions(e.target, cmdObj, isMeta); updatePreview(isMeta); 
    };
    cmdInp.onclick = (e) => e.stopPropagation();
    valArea.oninput = (e) => { 
        cmdObj.value = e.target.value; if(isHeader) currentSelection.item.id = e.target.value;
        if((cmdObj.cmd === '#name' || (currentSelection.item && currentSelection.item.type === 'event' && cmdObj.cmd === '#msg')) && currentSelection.item) { if(cmdObj.cmd === '#name') currentSelection.item.name = e.target.value.replace(/"/g, ''); renderList(); }
        autoResize(valArea); updatePreview(isMeta); 
    };
    comInp.oninput = (e) => { cmdObj.comment = e.target.value; if(isHeader) renderList(); updatePreview(isMeta); };
    setTimeout(() => autoResize(valArea), 0);
    return row;
}

function buildRawRow(cmd, idx, isMeta = false) {
    const row = document.createElement('div'); row.className = 'form-row';
    row.innerHTML = `<div class="lbl" style="opacity:0.2">--</div><textarea class="auto-textarea" style="color:var(--sh-comment); border:none; background:none;">${cmd.value}</textarea><div class="row-actions"><i class="fa-solid fa-plus btn-action" onclick="insertRow(${idx}, ${isMeta})"></i><i class="fa-solid fa-trash-can btn-action" onclick="deleteProp(${idx}, ${isMeta})"></i></div>`;
    const area = row.querySelector('textarea');
    area.oninput = (e) => { cmd.value = e.target.value; autoResize(area); updatePreview(isMeta); };
    setTimeout(() => autoResize(area), 0);
    return row;
}
function insertRow(idx, isMeta) { const target = isMeta ? modData.metadata : currentSelection.item.commands; target.splice(idx + 1, 0, { cmd: "#", value: "", comment: "" }); isMeta ? loadMetadata() : loadItem(currentSelection.item); }
function deleteProp(idx, isMeta) { customConfirm("确定要删除这一行属性吗？", () => { if (isMeta) modData.metadata.splice(idx, 1); else currentSelection.item.commands.splice(idx, 1); isMeta ? loadMetadata() : loadItem(currentSelection.item); }); }
function createNewItem() { const cat = CATEGORIES.find(c => c.id === currentSelection.catId); if (!cat || cat.id === 'god') return; if (cat.id === 'metadata') { addMetaTag('#modname'); return; } const newItem = { type: cat.id, id: "999", name: "New Item", header: { cmd: cat.prefix, value: "999", comment: "" }, commands: [{ cmd: "#name", value: '"New Item"', comment: "" }] }; modData[cat.id].unshift(newItem); renderList(); loadItem(newItem); updateStats(); }

// --- Duplicate Logic ---
function duplicateItem(e, cat, idx) {
    e.stopPropagation();
    const original = modData[cat][idx];
    const copy = JSON.parse(JSON.stringify(original));
    if (copy.name) copy.name += " (Copy)";
    const nameCmd = copy.commands.find(c => c.cmd === '#name');
    if (nameCmd) nameCmd.value = `"${copy.name}"`;
    modData[cat].splice(idx + 1, 0, copy);
    renderList();
    updateStats();
}

function updatePreview(isMeta = false) { const item = currentSelection.item; if(!item) return; let code = ""; const span = (t, c) => `<span class="${c}">${t}</span>`; if (isMeta) { modData.metadata.forEach(c => { if(c.cmd === 'raw') code += span(c.value, 'tok-com') + "\n"; else code += `${span(c.cmd, 'tok-cmd')} ${span(c.value, 'tok-val')}${c.comment ? ' ' + span('-- '+c.comment, 'tok-com') : ''}\n`; }); } else { code += `${span(item.header.cmd, 'tok-kw')} ${span(item.header.value, 'tok-val')}${item.header.comment ? ' ' + span('-- '+item.header.comment, 'tok-com') : ''}\n`; item.commands.forEach(c => { if(c.cmd === 'raw') code += span(c.value, 'tok-com') + "\n"; else code += `  ${span(c.cmd, 'tok-cmd')} ${span(c.value, 'tok-val')}${c.comment ? ' ' + span('-- '+c.comment, 'tok-com') : ''}\n`; }); code += span('#end', 'tok-kw'); } document.getElementById('codePreview').innerHTML = code; }
function updateStats() { let total = 0; CATEGORIES.forEach(c => { if(c.id !== 'metadata') total += (modData[c.id]?.length || 0); }); const content = document.getElementById('statsContent'); content.innerHTML = ''; CATEGORIES.forEach(c => { if(c.id === 'metadata') return; const count = modData[c.id]?.length || 0; const percentage = total > 0 ? (count / total) * 100 : 0; content.innerHTML += `<div class="stat-box"><div style="font-size:11px; color:#888">${c.label}</div><div style="font-size:18px; font-weight:bold">${count}</div><div class="stat-bar-outer"><div class="stat-bar-inner" style="width:${percentage}%"></div></div></div>`; }); document.getElementById('objCount').innerText = "总计: " + total; }
function toggleBottomPanel() { const p = document.getElementById('bottomPanel'); p.style.height = p.style.height === '180px' ? '0' : '180px'; if(p.style.height === '180px') updateStats(); }
function exportFile() { let out = ""; modData.metadata.forEach(m => out += (m.cmd==='raw'? m.value : `${m.cmd} ${m.value}${m.comment?' -- '+m.comment:''}`) + "\n"); CATEGORIES.forEach(cat => { if(['metadata','god'].includes(cat.id)) return; (modData[cat.id]||[]).forEach(item => { out += `\n${item.header.cmd} ${item.header.value}${item.header.comment?' -- '+item.header.comment:''}\n`; item.commands.forEach(c => out += (c.cmd==='raw' ? c.value : `  ${c.cmd} ${c.value}${c.comment?' -- '+c.comment:''}`) + "\n"); out += "#end\n"; }); }); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([out], {type: "text/plain"})); a.download = "mod_export.dm"; a.click(); }
function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
function copyPreview() { navigator.clipboard.writeText(document.getElementById('codePreview').innerText); }
function loadFile(input) { const reader = new FileReader(); reader.onload = (e) => parseText(e.target.result); reader.readAsText(input.files[0]); }
function filterItems() { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.entry-item').forEach(el => { el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }); }
function removeItem(e, cat, idx) { e.stopPropagation(); customConfirm(`确定要删除这个条目 (${modData[cat][idx].name || '未命名'}) 吗？`, () => { modData[cat].splice(idx, 1); renderList(); updateStats(); }); }
function scrollToActive() { setTimeout(() => { const activeItem = document.querySelector('.entry-item.active'); if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50); }

// --- Meta Tag Logic ---
function showMetaSelector() {
    const options = [
        { t: '#modname', d: 'Mod名称' }, { t: '#description', d: '描述' }, { t: '#icon', d: '图标路径' },
        { t: '#version', d: '版本号' }, { t: '#domversion', d: '游戏版本' }, { t: '#', d: '自定义标签...' }
    ];
    let listHtml = '<div class="vsc-list">';
    options.forEach(opt => { listHtml += `<div class="vsc-list-item" onclick="addMetaTag('${opt.t}')">${opt.t} <span style="color:#666">(${opt.d})</span></div>`; });
    listHtml += '</div>';
    openModal("SELECT META TAG", listHtml, `<button class="btn-secondary" onclick="closeModal()">取消</button>`);
}
function addMetaTag(tag) { modData.metadata.push({ cmd: tag, value: tag === '#modname' ? '"New Mod"' : '', comment: "" }); closeModal(); loadMetadata(); }

document.addEventListener('DOMContentLoaded', () => { 
    renderTree(); 
    loadCmdDocs();
    setTimeout(() => tour.start(), 1000); 
});
</script>
</body>
</html>